<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMatrix Pro 提醒功能测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .test-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1d4ed8;
        }
        .test-button.danger {
            background: #dc2626;
        }
        .test-button.danger:hover {
            background: #b91c1c;
        }
        .log {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .urgent-tasks {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .urgent-tasks h3 {
            color: #92400e;
            margin-top: 0;
        }
        .task-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <h1>TaskMatrix Pro 提醒功能测试</h1>
    
    <div class="test-section">
        <h2>任务监控控制</h2>
        <button class="test-button" onclick="startMonitoring()">启动任务监控</button>
        <button class="test-button danger" onclick="stopMonitoring()">停止任务监控</button>
        <button class="test-button" onclick="getMonitoringStatus()">获取监控状态</button>
        <button class="test-button" onclick="getTasks()">获取任务列表</button>
        <button class="test-button" onclick="createTestTasks()">创建测试任务</button>
        <button class="test-button danger" onclick="clearAllTasks()">清空所有任务</button>
        <button class="test-button" onclick="clearLog()">清除日志</button>
        
        <div id="status" class="status info">
            等待测试...
        </div>
    </div>
    
    <div class="test-section">
        <h2>紧急任务状态</h2>
        <div id="urgentTasks" class="urgent-tasks">
            <h3>暂无紧急任务</h3>
            <p>当有任务在30分钟内到期时，这里会显示任务信息</p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>测试日志</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function updateUrgentTasks(urgentTasks) {
            const urgentTasksElement = document.getElementById('urgentTasks');
            
            if (urgentTasks.length === 0) {
                urgentTasksElement.innerHTML = `
                    <h3>暂无紧急任务</h3>
                    <p>当有任务在30分钟内到期时，这里会显示任务信息</p>
                `;
            } else {
                let tasksHtml = `<h3>发现 ${urgentTasks.length} 个紧急任务</h3>`;
                
                urgentTasks.forEach(task => {
                    tasksHtml += `
                        <div class="task-item">
                            <strong>${task.title}</strong><br>
                            剩余时间: ${task.minutesRemaining} 分钟<br>
                            状态: ${task.status}
                        </div>
                    `;
                });
                
                urgentTasksElement.innerHTML = tasksHtml;
            }
        }

        async function startMonitoring() {
            try {
                log('启动任务监控...');
                
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                
                const response = await chrome.runtime.sendMessage({ type: 'startMonitoring' });
                log(`监控启动响应: ${JSON.stringify(response)}`);
                
                if (response && response.success) {
                    updateStatus('任务监控已启动', 'success');
                    log('任务监控启动成功');
                } else {
                    throw new Error('启动监控失败');
                }
                
            } catch (error) {
                log(`启动监控失败: ${error.message}`);
                updateStatus(`启动监控失败: ${error.message}`, 'error');
            }
        }

        async function stopMonitoring() {
            try {
                log('停止任务监控...');
                
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                
                const response = await chrome.runtime.sendMessage({ type: 'stopMonitoring' });
                log(`监控停止响应: ${JSON.stringify(response)}`);
                
                if (response && response.success) {
                    updateStatus('任务监控已停止', 'success');
                    log('任务监控停止成功');
                } else {
                    throw new Error('停止监控失败');
                }
                
            } catch (error) {
                log(`停止监控失败: ${error.message}`);
                updateStatus(`停止监控失败: ${error.message}`, 'error');
            }
        }

        async function getMonitoringStatus() {
            try {
                log('获取监控状态...');
                
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                
                // 这里我们需要通过其他方式获取状态，因为background script没有直接暴露这个方法
                // 我们可以通过getTasks来间接了解状态
                const response = await chrome.runtime.sendMessage({ type: 'getTasks' });
                log(`获取任务响应: ${JSON.stringify(response)}`);
                
                if (response && response.success) {
                    updateStatus('成功获取任务列表', 'success');
                    log(`获取到 ${response.data.length} 个任务`);
                    
                    // 分析任务状态
                    const now = Date.now();
                    const thirtyMinutes = 30 * 60 * 1000;
                    const urgentTasks = response.data.filter(task => {
                        if (task.status === 'doing') {
                            const timeRemaining = task.dueDate - now;
                            return timeRemaining > 0 && timeRemaining <= thirtyMinutes;
                        }
                        return false;
                    });
                    
                    updateUrgentTasks(urgentTasks);
                    
                } else {
                    throw new Error('获取任务失败');
                }
                
            } catch (error) {
                log(`获取监控状态失败: ${error.message}`);
                updateStatus(`获取监控状态失败: ${error.message}`, 'error');
            }
        }

        async function getTasks() {
            try {
                log('获取任务列表...');
                
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                
                const response = await chrome.runtime.sendMessage({ type: 'getTasks' });
                log(`获取任务响应: ${JSON.stringify(response)}`);
                
                if (response && response.success) {
                    updateStatus(`成功获取 ${response.data.length} 个任务`, 'success');
                    
                    // 显示任务详情
                    response.data.forEach(task => {
                        const dueDate = new Date(task.dueDate);
                        const timeRemaining = task.dueDate - Date.now();
                        const minutesRemaining = Math.ceil(timeRemaining / (60 * 1000));
                        
                        log(`任务: ${task.title}`);
                        log(`  到期时间: ${dueDate.toLocaleString()}`);
                        log(`  剩余时间: ${minutesRemaining} 分钟`);
                        log(`  状态: ${task.status}`);
                        log('---');
                    });
                    
                } else {
                    throw new Error('获取任务失败');
                }
                
            } catch (error) {
                log(`获取任务失败: ${error.message}`);
                updateStatus(`获取任务失败: ${error.message}`, 'error');
            }
        }

        async function createTestTasks() {
            try {
                log('创建测试任务...');
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                const response = await chrome.runtime.sendMessage({ type: 'createTestTasks' });
                log(`创建测试任务响应: ${JSON.stringify(response)}`);
                if (response && response.success) {
                    updateStatus('测试任务已创建', 'success');
                    log('测试任务创建成功');
                    getMonitoringStatus(); // 重新获取状态以更新紧急任务列表
                } else {
                    throw new Error('创建测试任务失败');
                }
            } catch (error) {
                log(`创建测试任务失败: ${error.message}`);
                updateStatus(`创建测试任务失败: ${error.message}`, 'error');
            }
        }

        async function clearAllTasks() {
            try {
                log('清空所有任务...');
                if (!chrome.runtime?.id) {
                    throw new Error('扩展上下文无效');
                }
                const response = await chrome.runtime.sendMessage({ type: 'clearAllTasks' });
                log(`清空任务响应: ${JSON.stringify(response)}`);
                if (response && response.success) {
                    updateStatus('所有任务已清空', 'success');
                    log('所有任务清空成功');
                    getMonitoringStatus(); // 重新获取状态以更新紧急任务列表
                } else {
                    throw new Error('清空任务失败');
                }
            } catch (error) {
                log(`清空任务失败: ${error.message}`);
                updateStatus(`清空任务失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动检查扩展状态
        window.addEventListener('load', () => {
            log('页面加载完成，开始检查扩展状态...');
            setTimeout(() => {
                getMonitoringStatus();
            }, 1000);
        });

        // 监听来自扩展的消息
        if (chrome && chrome.runtime) {
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                log(`收到扩展消息: ${JSON.stringify(message)}`);
                return true;
            });
        }
    </script>
</body>
</html> 